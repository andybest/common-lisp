(in-package #:cl-user)

;;;; 4-dimensional OpenSimplex2S noise generator

(defpackage #:%cricket.generators.open-simplex2s-4d
  (:local-nicknames
   (#:gen #:%cricket.generators)
   (#:int #:%cricket.internal)
   (#:rng #:seedable-rng)
   (#:u #:mfiano-utils))
  (:use #:cl))

(in-package #:%cricket.generators.open-simplex2s-4d)

(u:eval-always
  (defstruct (lattice-point
              (:constructor %make-lattice-point)
              (:conc-name nil)
              (:predicate nil)
              (:copier nil))
    (xsv 0 :type u:b32)
    (ysv 0 :type u:b32)
    (zsv 0 :type u:b32)
    (wsv 0 :type u:b32)
    (dx 0d0 :type u:f64)
    (dy 0d0 :type u:f64)
    (dz 0d0 :type u:f64)
    (dw 0d0 :type u:f64))

  (defmethod make-load-form ((object lattice-point) &optional environment)
    (declare (ignore environment))
    (make-load-form-saving-slots object))

  (defun make-lattice-point (xsv ysv zsv wsv)
    (let ((ssv (* (+ xsv ysv zsv wsv) -0.138196601125011d0)))
      (%make-lattice-point :xsv xsv
                           :ysv ysv
                           :zsv zsv
                           :wsv wsv
                           :dx (- (- xsv) ssv)
                           :dy (- (- ysv) ssv)
                           :dz (- (- zsv) ssv)
                           :dw (- (- wsv) ssv)))))

(u:define-constant +lookup-pregen+
    #(#(21 69 81 84 85 86 89 90 101 102 105 106 149 150 153 154 165 166 169 170)
      #(21 69 81 85 86 89 90 101 102 106 149 150 154 166 170)
      #(1 5 17 21 65 69 81 85 86 90 102 106 150 154 166 170)
      #(1 21 22 69 70 81 82 85 86 90 102 106 150 154 166 170 171)
      #(21 69 84 85 86 89 90 101 105 106 149 153 154 169 170)
      #(5 21 69 85 86 89 90 101 102 105 106 149 150 153 154 170)
      #(5 21 69 85 86 89 90 102 106 150 154 170)
      #(5 21 22 69 70 85 86 89 90 102 106 150 154 170 171)
      #(4 5 20 21 68 69 84 85 89 90 105 106 153 154 169 170)
      #(5 21 69 85 86 89 90 105 106 153 154 170)
      #(5 21 69 85 86 89 90 106 154 170)
      #(5 21 22 69 70 85 86 89 90 91 106 154 170 171)
      #(4 21 25 69 73 84 85 88 89 90 105 106 153 154 169 170 174)
      #(5 21 25 69 73 85 86 89 90 105 106 153 154 170 174)
      #(5 21 25 69 73 85 86 89 90 94 106 154 170 174)
      #(5 21 26 69 74 85 86 89 90 91 94 106 154 170 171 174 175)
      #(21 81 84 85 86 89 101 102 105 106 149 165 166 169 170)
      #(17 21 81 85 86 89 90 101 102 105 106 149 150 165 166 170)
      #(17 21 81 85 86 90 101 102 106 150 166 170)
      #(17 21 22 81 82 85 86 90 101 102 106 150 166 170 171)
      #(20 21 84 85 86 89 90 101 102 105 106 149 153 165 169 170)
      #(21 85 86 89 90 101 102 105 106 149 154 166 169 170)
      #(21 85 86 89 90 101 102 105 106 150 154 166 170 171)
      #(21 22 85 86 90 102 106 107 150 154 166 170 171)
      #(20 21 84 85 89 90 101 105 106 153 169 170)
      #(21 85 86 89 90 101 102 105 106 153 154 169 170 174)
      #(21 85 86 89 90 101 102 105 106 154 170)
      #(21 22 85 86 89 90 102 106 107 154 170 171)
      #(20 21 25 84 85 88 89 90 101 105 106 153 169 170 174)
      #(21 25 85 89 90 105 106 110 153 154 169 170 174)
      #(21 25 85 86 89 90 105 106 110 154 170 174)
      #(21 26 85 86 89 90 106 107 110 154 170 171 174 175)
      #(16 17 20 21 80 81 84 85 101 102 105 106 165 166 169 170)
      #(17 21 81 85 86 101 102 105 106 165 166 170)
      #(17 21 81 85 86 101 102 106 166 170)
      #(17 21 22 81 82 85 86 101 102 103 106 166 170 171)
      #(20 21 84 85 89 101 102 105 106 165 169 170)
      #(21 85 86 89 90 101 102 105 106 165 166 169 170 186)
      #(21 85 86 89 90 101 102 105 106 166 170)
      #(21 22 85 86 90 101 102 106 107 166 170 171)
      #(20 21 84 85 89 101 105 106 169 170)
      #(21 85 86 89 90 101 102 105 106 169 170)
      #(21 85 86 89 90 101 102 105 106 170)
      #(21 22 85 86 89 90 101 102 105 106 107 170 171)
      #(20 21 25 84 85 88 89 101 105 106 109 169 170 174)
      #(21 25 85 89 90 101 105 106 110 169 170 174)
      #(21 25 85 86 89 90 101 102 105 106 110 170 174)
      #(21 85 86 89 90 102 105 106 107 110 154 170 171 174 175)
      #(16 21 37 81 84 85 97 100 101 102 105 106 165 166 169 170 186)
      #(17 21 37 81 85 86 97 101 102 105 106 165 166 170 186)
      #(17 21 37 81 85 86 97 101 102 106 118 166 170 186)
      #(17 21 38 81 85 86 98 101 102 103 106 118 166 170 171 186 187)
      #(20 21 37 84 85 89 100 101 102 105 106 165 169 170 186)
      #(21 37 85 101 102 105 106 122 165 166 169 170 186)
      #(21 37 85 86 101 102 105 106 122 166 170 186)
      #(21 38 85 86 101 102 106 107 122 166 170 171 186 187)
      #(20 21 37 84 85 89 100 101 105 106 121 169 170 186)
      #(21 37 85 89 101 102 105 106 122 169 170 186)
      #(21 37 85 86 89 90 101 102 105 106 122 170 186)
      #(21 85 86 90 101 102 105 106 107 122 166 170 171 186 187)
      #(20 21 41 84 85 89 101 104 105 106 109 121 169 170 174 186 190)
      #(21 41 85 89 101 105 106 110 122 169 170 174 186 190)
      #(21 85 89 90 101 102 105 106 110 122 169 170 174 186 190)
      #(21 85 86 89 90 101 102 105 106 107 110 122 170 171 174 186 191)
      #(69 81 84 85 86 89 101 149 150 153 154 165 166 169 170)
      #(65 69 81 85 86 89 90 101 102 149 150 153 154 165 166 170)
      #(65 69 81 85 86 90 102 149 150 154 166 170)
      #(65 69 70 81 82 85 86 90 102 149 150 154 166 170 171)
      #(68 69 84 85 86 89 90 101 105 149 150 153 154 165 169 170)
      #(69 85 86 89 90 101 106 149 150 153 154 166 169 170)
      #(69 85 86 89 90 102 106 149 150 153 154 166 170 171)
      #(69 70 85 86 90 102 106 150 154 155 166 170 171)
      #(68 69 84 85 89 90 105 149 153 154 169 170)
      #(69 85 86 89 90 105 106 149 150 153 154 169 170 174)
      #(69 85 86 89 90 106 149 150 153 154 170)
      #(69 70 85 86 89 90 106 150 154 155 170 171)
      #(68 69 73 84 85 88 89 90 105 149 153 154 169 170 174)
      #(69 73 85 89 90 105 106 153 154 158 169 170 174)
      #(69 73 85 86 89 90 106 153 154 158 170 174)
      #(69 74 85 86 89 90 106 154 155 158 170 171 174 175)
      #(80 81 84 85 86 89 101 102 105 149 150 153 165 166 169 170)
      #(81 85 86 89 101 102 106 149 150 154 165 166 169 170)
      #(81 85 86 90 101 102 106 149 150 154 165 166 170 171)
      #(81 82 85 86 90 102 106 150 154 166 167 170 171)
      #(84 85 86 89 101 105 106 149 153 154 165 166 169 170)
      #(85 86 89 90 101 102 105 106 149 150 153 154 165 166 169 170)
      #(21 69 81 85 86 89 90 101 102 106 149 150 154 166 170 171)
      #(85 86 90 102 106 150 154 166 170 171)
      #(84 85 89 90 101 105 106 149 153 154 165 169 170 174)
      #(21 69 84 85 86 89 90 101 105 106 149 153 154 169 170 174)
      #(21 69 85 86 89 90 101 102 105 106 149 150 153 154 166 169 170 171 174)
      #(85 86 89 90 102 106 150 154 166 170 171)
      #(84 85 88 89 90 105 106 153 154 169 170 173 174)
      #(85 89 90 105 106 153 154 169 170 174)
      #(85 86 89 90 105 106 153 154 169 170 174)
      #(85 86 89 90 106 154 170 171 174 175)
      #(80 81 84 85 101 102 105 149 165 166 169 170)
      #(81 85 86 101 102 105 106 149 150 165 166 169 170 186)
      #(81 85 86 101 102 106 149 150 165 166 170)
      #(81 82 85 86 101 102 106 150 166 167 170 171)
      #(84 85 89 101 102 105 106 149 153 165 166 169 170 186)
      #(21 81 84 85 86 89 101 102 105 106 149 165 166 169 170 186)
      #(21 81 85 86 89 90 101 102 105 106 149 150 154 165 166 169 170 171 186)
      #(85 86 90 101 102 106 150 154 166 170 171)
      #(84 85 89 101 105 106 149 153 165 169 170)
      #(21 84 85 86 89 90 101 102 105 106 149 153 154 165 166 169 170 174 186)
      #(21 85 86 89 90 101 102 105 106 154 166 169 170)
      #(21 85 86 89 90 101 102 105 106 150 154 166 170 171)
      #(84 85 88 89 101 105 106 153 169 170 173 174)
      #(85 89 90 101 105 106 153 154 169 170 174)
      #(21 85 86 89 90 101 102 105 106 153 154 169 170 174)
      #(21 85 86 89 90 102 105 106 154 170 171 174 175)
      #(80 81 84 85 97 100 101 102 105 149 165 166 169 170 186)
      #(81 85 97 101 102 105 106 165 166 169 170 182 186)
      #(81 85 86 97 101 102 106 165 166 170 182 186)
      #(81 85 86 98 101 102 106 166 167 170 171 182 186 187)
      #(84 85 100 101 102 105 106 165 166 169 170 185 186)
      #(85 101 102 105 106 165 166 169 170 186)
      #(85 86 101 102 105 106 165 166 169 170 186)
      #(85 86 101 102 106 166 170 171 186 187)
      #(84 85 89 100 101 105 106 165 169 170 185 186)
      #(85 89 101 102 105 106 165 166 169 170 186)
      #(21 85 86 89 90 101 102 105 106 165 166 169 170 186)
      #(21 85 86 90 101 102 105 106 166 170 171 186 187)
      #(84 85 89 101 104 105 106 169 170 173 174 185 186 190)
      #(85 89 101 105 106 169 170 174 186 190)
      #(21 85 89 90 101 102 105 106 169 170 174 186 190)
      #(85 86 89 90 101 102 105 106 170 171 174 186 191)
      #(64 65 68 69 80 81 84 85 149 150 153 154 165 166 169 170)
      #(65 69 81 85 86 149 150 153 154 165 166 170)
      #(65 69 81 85 86 149 150 154 166 170)
      #(65 69 70 81 82 85 86 149 150 151 154 166 170 171)
      #(68 69 84 85 89 149 150 153 154 165 169 170)
      #(69 85 86 89 90 149 150 153 154 165 166 169 170 234)
      #(69 85 86 89 90 149 150 153 154 166 170)
      #(69 70 85 86 90 149 150 154 155 166 170 171)
      #(68 69 84 85 89 149 153 154 169 170)
      #(69 85 86 89 90 149 150 153 154 169 170)
      #(69 85 86 89 90 149 150 153 154 170)
      #(69 70 85 86 89 90 149 150 153 154 155 170 171)
      #(68 69 73 84 85 88 89 149 153 154 157 169 170 174)
      #(69 73 85 89 90 149 153 154 158 169 170 174)
      #(69 73 85 86 89 90 149 150 153 154 158 170 174)
      #(69 85 86 89 90 106 150 153 154 155 158 170 171 174 175)
      #(80 81 84 85 101 149 150 153 165 166 169 170)
      #(81 85 86 101 102 149 150 153 154 165 166 169 170 234)
      #(81 85 86 101 102 149 150 154 165 166 170)
      #(81 82 85 86 102 149 150 154 166 167 170 171)
      #(84 85 89 101 105 149 150 153 154 165 166 169 170 234)
      #(69 81 84 85 86 89 101 149 150 153 154 165 166 169 170 234)
      #(69 81 85 86 89 90 101 102 106 149 150 153 154 165 166 169 170 171 234)
      #(85 86 90 102 106 149 150 154 166 170 171)
      #(84 85 89 101 105 149 153 154 165 169 170)
      #(69 84 85 86 89 90 101 105 106 149 150 153 154 165 166 169 170 174 234)
      #(69 85 86 89 90 106 149 150 153 154 166 169 170)
      #(69 85 86 89 90 102 106 149 150 153 154 166 170 171)
      #(84 85 88 89 105 149 153 154 169 170 173 174)
      #(85 89 90 105 106 149 153 154 169 170 174)
      #(69 85 86 89 90 105 106 149 150 153 154 169 170 174)
      #(69 85 86 89 90 106 150 153 154 170 171 174 175)
      #(80 81 84 85 101 149 165 166 169 170)
      #(81 85 86 101 102 149 150 165 166 169 170)
      #(81 85 86 101 102 149 150 165 166 170)
      #(81 82 85 86 101 102 149 150 165 166 167 170 171)
      #(84 85 89 101 105 149 153 165 166 169 170)
      #(81 84 85 86 89 101 102 105 106 149 150 153 154 165 166 169 170 186 234)
      #(81 85 86 101 102 106 149 150 154 165 166 169 170)
      #(81 85 86 90 101 102 106 149 150 154 165 166 170 171)
      #(84 85 89 101 105 149 153 165 169 170)
      #(84 85 89 101 105 106 149 153 154 165 166 169 170)
      #(85 86 89 90 101 102 105 106 149 150 153 154 165 166 169 170)
      #(85 86 89 90 101 102 106 149 150 154 166 169 170 171)
      #(84 85 88 89 101 105 149 153 165 169 170 173 174)
      #(84 85 89 90 101 105 106 149 153 154 165 169 170 174)
      #(85 86 89 90 101 105 106 149 153 154 166 169 170 174)
      #(85 86 89 90 102 105 106 150 153 154 166 169 170 171 174 175)
      #(80 81 84 85 97 100 101 149 165 166 169 170 181 186)
      #(81 85 97 101 102 149 165 166 169 170 182 186)
      #(81 85 86 97 101 102 149 150 165 166 170 182 186)
      #(81 85 86 101 102 106 150 165 166 167 170 171 182 186 187)
      #(84 85 100 101 105 149 165 166 169 170 185 186)
      #(85 101 102 105 106 149 165 166 169 170 186)
      #(81 85 86 101 102 105 106 149 150 165 166 169 170 186)
      #(81 85 86 101 102 106 150 165 166 170 171 186 187)
      #(84 85 89 100 101 105 149 153 165 169 170 185 186)
      #(84 85 89 101 102 105 106 149 153 165 166 169 170 186)
      #(85 86 89 101 102 105 106 149 154 165 166 169 170 186)
      #(85 86 90 101 102 105 106 150 154 165 166 169 170 171 186 187)
      #(84 85 89 101 105 106 153 165 169 170 173 174 185 186 190)
      #(84 85 89 101 105 106 153 165 169 170 174 186 190)
      #(85 89 90 101 102 105 106 153 154 165 166 169 170 174 186 190)
      #(85 86 89 90 101 102 105 106 154 166 169 170 171 174 186)
      #(64 69 81 84 85 133 145 148 149 150 153 154 165 166 169 170 234)
      #(65 69 81 85 86 133 145 149 150 153 154 165 166 170 234)
      #(65 69 81 85 86 133 145 149 150 154 166 170 214 234)
      #(65 69 81 85 86 134 146 149 150 151 154 166 170 171 214 234 235)
      #(68 69 84 85 89 133 148 149 150 153 154 165 169 170 234)
      #(69 85 133 149 150 153 154 165 166 169 170 218 234)
      #(69 85 86 133 149 150 153 154 166 170 218 234)
      #(69 85 86 134 149 150 154 155 166 170 171 218 234 235)
      #(68 69 84 85 89 133 148 149 153 154 169 170 217 234)
      #(69 85 89 133 149 150 153 154 169 170 218 234)
      #(69 85 86 89 90 133 149 150 153 154 170 218 234)
      #(69 85 86 90 149 150 153 154 155 166 170 171 218 234 235)
      #(68 69 84 85 89 137 149 152 153 154 157 169 170 174 217 234 238)
      #(69 85 89 137 149 153 154 158 169 170 174 218 234 238)
      #(69 85 89 90 149 150 153 154 158 169 170 174 218 234 238)
      #(69 85 86 89 90 149 150 153 154 155 158 170 171 174 218 234 239)
      #(80 81 84 85 101 145 148 149 150 153 165 166 169 170 234)
      #(81 85 145 149 150 153 154 165 166 169 170 230 234)
      #(81 85 86 145 149 150 154 165 166 170 230 234)
      #(81 85 86 146 149 150 154 166 167 170 171 230 234 235)
      #(84 85 148 149 150 153 154 165 166 169 170 233 234)
      #(85 149 150 153 154 165 166 169 170 234)
      #(85 86 149 150 153 154 165 166 169 170 234)
      #(85 86 149 150 154 166 170 171 234 235)
      #(84 85 89 148 149 153 154 165 169 170 233 234)
      #(85 89 149 150 153 154 165 166 169 170 234)
      #(69 85 86 89 90 149 150 153 154 165 166 169 170 234)
      #(69 85 86 90 149 150 153 154 166 170 171 234 235)
      #(84 85 89 149 152 153 154 169 170 173 174 233 234 238)
      #(85 89 149 153 154 169 170 174 234 238)
      #(69 85 89 90 149 150 153 154 169 170 174 234 238)
      #(85 86 89 90 149 150 153 154 170 171 174 234 239)
      #(80 81 84 85 101 145 148 149 165 166 169 170 229 234)
      #(81 85 101 145 149 150 165 166 169 170 230 234)
      #(81 85 86 101 102 145 149 150 165 166 170 230 234)
      #(81 85 86 102 149 150 154 165 166 167 170 171 230 234 235)
      #(84 85 101 148 149 153 165 166 169 170 233 234)
      #(85 101 149 150 153 154 165 166 169 170 234)
      #(81 85 86 101 102 149 150 153 154 165 166 169 170 234)
      #(81 85 86 102 149 150 154 165 166 170 171 234 235)
      #(84 85 89 101 105 148 149 153 165 169 170 233 234)
      #(84 85 89 101 105 149 150 153 154 165 166 169 170 234)
      #(85 86 89 101 106 149 150 153 154 165 166 169 170 234)
      #(85 86 90 102 106 149 150 153 154 165 166 169 170 171 234 235)
      #(84 85 89 105 149 153 154 165 169 170 173 174 233 234 238)
      #(84 85 89 105 149 153 154 165 169 170 174 234 238)
      #(85 89 90 105 106 149 150 153 154 165 166 169 170 174 234 238)
      #(85 86 89 90 106 149 150 153 154 166 169 170 171 174 234)
      #(80 81 84 85 101 149 161 164 165 166 169 170 181 186 229 234 250)
      #(81 85 101 149 161 165 166 169 170 182 186 230 234 250)
      #(81 85 101 102 149 150 165 166 169 170 182 186 230 234 250)
      #(81 85 86 101 102 149 150 165 166 167 170 171 182 186 230 234 251)
      #(84 85 101 149 164 165 166 169 170 185 186 233 234 250)
      #(85 101 149 165 166 169 170 186 234 250)
      #(81 85 101 102 149 150 165 166 169 170 186 234 250)
      #(85 86 101 102 149 150 165 166 170 171 186 234 251)
      #(84 85 101 105 149 153 165 166 169 170 185 186 233 234 250)
      #(84 85 101 105 149 153 165 166 169 170 186 234 250)
      #(85 101 102 105 106 149 150 153 154 165 166 169 170 186 234 250)
      #(85 86 101 102 106 149 150 154 165 166 169 170 171 186 234)
      #(84 85 89 101 105 149 153 165 169 170 173 174 185 186 233 234 254)
      #(85 89 101 105 149 153 165 169 170 174 186 234 254)
      #(85 89 101 105 106 149 153 154 165 166 169 170 174 186 234)
      #(85 86 89 90 101 102 105 106 149 150 153 154 165 166 169 170 171 174 186 234))
  :test #'equalp)

(u:define-constant +lookup+
    (let ((lattice-points (make-array 256))
          (table (make-array 256)))
      (dotimes (i 256)
        (let ((cx (1- (logand i 3)))
              (cy (1- (logand (ash i -2) 3)))
              (cz (1- (logand (ash i -4) 3)))
              (cw (1- (logand (ash i -6) 3))))
          (setf (aref lattice-points i) (make-lattice-point cx cy cz cw))))
      (dotimes (i 256)
        (let* ((indices (aref +lookup-pregen+ i))
               (length (length indices)))
          (setf (aref table i) (make-array length))
          (dotimes (j length)
            (setf (aref (aref table i) j) (aref lattice-points (aref indices j))))))
      table)
  :test #'equalp)

(u:define-constant +gradients+
    (let ((gradients #(#(-6.770142979528568d0 -3.4121433062976583d0
                         -3.4121433062976583d0 3.4121433062976583d0)
                       #(-7.02920997061155d0 -3.8836313526790818d0
                         -3.8836313526790818d0 1.0899651432165038d0)
                       #(-7.02920997061155d0 -3.8836313526790818d0
                         1.0899651432165038d0 -3.8836313526790818d0)
                       #(-7.02920997061155d0 1.0899651432165038d0
                         -3.8836313526790818d0 3.8836313526790818d0)
                       #(-7.716544101711582d0 -4.570965483779114d0
                         0.40263101211647173d0 0.40263101211647173d0)
                       #(-7.716544101711582d0 0.40263101211647173d0
                         -4.570965483779114d0 0.40263101211647173d0)
                       #(-7.716544101711582d0 0.40263101211647173d0
                         0.40263101211647173d0 -4.570965483779114d0)
                       #(-8.971392480472286d0 -0.3039291324859653d0
                         -0.3039291324859653d0 0.3039291324859653d0)
                       #(-3.4121433062976583d0 -6.770142979528568d0
                         -3.4121433062976583d0 3.4121433062976583d0)
                       #(-3.8836313526790818d0 -7.02920997061155d0
                         -3.8836313526790818d0 1.0899651432165038d0)
                       #(-3.8836313526790818d0 -7.02920997061155d0
                         1.0899651432165038d0 -3.8836313526790818d0)
                       #(1.0899651432165038d0 -7.02920997061155d0
                         -3.8836313526790818d0 3.8836313526790818d0)
                       #(-4.570965483779114d0 -7.716544101711582d0
                         0.40263101211647173d0 0.40263101211647173d0)
                       #(0.40263101211647173d0 -7.716544101711582d0
                         -4.570965483779114d0 0.40263101211647173d0)
                       #(0.40263101211647173d0 -7.716544101711582d0
                         0.40263101211647173d0 -4.570965483779114d0)
                       #(-0.3039291324859653d0 -8.971392480472286d0
                         -0.3039291324859653d0 0.3039291324859653d0)
                       #(-3.4121433062976583d0 -3.4121433062976583d0
                         -6.770142979528568d0 3.4121433062976583d0)
                       #(-3.8836313526790818d0 -3.8836313526790818d0
                         -7.02920997061155d0 1.0899651432165038d0)
                       #(-3.8836313526790818d0 1.0899651432165038d0
                         -7.02920997061155d0 3.8836313526790818d0)
                       #(1.0899651432165038d0 -3.8836313526790818d0
                         -7.02920997061155d0 3.8836313526790818d0)
                       #(-4.570965483779114d0 0.40263101211647173d0
                         -7.716544101711582d0 0.40263101211647173d0)
                       #(0.40263101211647173d0 -4.570965483779114d0
                         -7.716544101711582d0 0.40263101211647173d0)
                       #(0.40263101211647173d0 0.40263101211647173d0
                         -7.716544101711582d0 4.570965483779114d0)
                       #(-0.3039291324859653d0 -0.3039291324859653d0
                         -8.971392480472286d0 0.3039291324859653d0)
                       #(-3.4121433062976583d0 -3.4121433062976583d0
                         -3.4121433062976583d0 6.770142979528568d0)
                       #(-3.8836313526790818d0 -3.8836313526790818d0
                         1.0899651432165038d0 -7.02920997061155d0)
                       #(-3.8836313526790818d0 1.0899651432165038d0
                         -3.8836313526790818d0 7.02920997061155d0)
                       #(1.0899651432165038d0 -3.8836313526790818d0
                         -3.8836313526790818d0 7.02920997061155d0)
                       #(-4.570965483779114d0 0.40263101211647173d0
                         0.40263101211647173d0 -7.716544101711582d0)
                       #(0.40263101211647173d0 -4.570965483779114d0
                         0.40263101211647173d0 -7.716544101711582d0)
                       #(0.40263101211647173d0 0.40263101211647173d0
                         -4.570965483779114d0 7.716544101711582d0)
                       #(-0.3039291324859653d0 -0.3039291324859653d0
                         -0.3039291324859653d0 8.971392480472286d0)
                       #(-6.057172720527959d0 -2.9115941025954895d0
                         -2.9115941025954895d0 5.207581011232565d0)
                       #(-6.744506851627991d0 -3.5989282336955215d0
                         1.3746682622000646d0 4.520246880132533d0)
                       #(-6.744506851627991d0 1.3746682622000646d0
                         -3.5989282336955215d0 4.520246880132533d0)
                       #(-7.933713514338415d0 0.7337498336479062d0
                         0.7337498336479062d0 4.091749506878816d0)
                       #(-4.091749506878816d0 -0.7337498336479062d0
                         -0.7337498336479062d0 7.933713514338415d0)
                       #(-4.520246880132533d0 -1.3746682622000646d0
                         3.5989282336955215d0 6.744506851627991d0)
                       #(-4.520246880132533d0 3.5989282336955215d0
                         -1.3746682622000646d0 6.744506851627991d0)
                       #(-5.207581011232565d0 2.9115941025954895d0
                         2.9115941025954895d0 6.057172720527959d0)
                       #(-2.9115941025954895d0 -6.057172720527959d0
                         -2.9115941025954895d0 5.207581011232565d0)
                       #(-3.5989282336955215d0 -6.744506851627991d0
                         1.3746682622000646d0 4.520246880132533d0)
                       #(1.3746682622000646d0 -6.744506851627991d0
                         -3.5989282336955215d0 4.520246880132533d0)
                       #(0.7337498336479062d0 -7.933713514338415d0
                         0.7337498336479062d0 4.091749506878816d0)
                       #(-0.7337498336479062d0 -4.091749506878816d0
                         -0.7337498336479062d0 7.933713514338415d0)
                       #(-1.3746682622000646d0 -4.520246880132533d0
                         3.5989282336955215d0 6.744506851627991d0)
                       #(3.5989282336955215d0 -4.520246880132533d0
                         -1.3746682622000646d0 6.744506851627991d0)
                       #(2.9115941025954895d0 -5.207581011232565d0
                         2.9115941025954895d0 6.057172720527959d0)
                       #(-2.9115941025954895d0 -2.9115941025954895d0
                         -6.057172720527959d0 5.207581011232565d0)
                       #(-3.5989282336955215d0 1.3746682622000646d0
                         -6.744506851627991d0 4.520246880132533d0)
                       #(1.3746682622000646d0 -3.5989282336955215d0
                         -6.744506851627991d0 4.520246880132533d0)
                       #(0.7337498336479062d0 0.7337498336479062d0
                         -7.933713514338415d0 4.091749506878816d0)
                       #(-0.7337498336479062d0 -0.7337498336479062d0
                         -4.091749506878816d0 7.933713514338415d0)
                       #(-1.3746682622000646d0 3.5989282336955215d0
                         -4.520246880132533d0 6.744506851627991d0)
                       #(3.5989282336955215d0 -1.3746682622000646d0
                         -4.520246880132533d0 6.744506851627991d0)
                       #(2.9115941025954895d0 2.9115941025954895d0
                         -5.207581011232565d0 6.057172720527959d0)
                       #(-6.057172720527959d0 -2.9115941025954895d0
                         5.207581011232565d0 -2.9115941025954895d0)
                       #(-6.744506851627991d0 -3.5989282336955215d0
                         4.520246880132533d0 1.3746682622000646d0)
                       #(-6.744506851627991d0 1.3746682622000646d0
                         4.520246880132533d0 -3.5989282336955215d0)
                       #(-7.933713514338415d0 0.7337498336479062d0
                         4.091749506878816d0 0.7337498336479062d0)
                       #(-4.091749506878816d0 -0.7337498336479062d0
                         7.933713514338415d0 -0.7337498336479062d0)
                       #(-4.520246880132533d0 -1.3746682622000646d0
                         6.744506851627991d0 3.5989282336955215d0)
                       #(-4.520246880132533d0 3.5989282336955215d0
                         6.744506851627991d0 -1.3746682622000646d0)
                       #(-5.207581011232565d0 2.9115941025954895d0
                         6.057172720527959d0 2.9115941025954895d0)
                       #(-2.9115941025954895d0 -6.057172720527959d0
                         5.207581011232565d0 -2.9115941025954895d0)
                       #(-3.5989282336955215d0 -6.744506851627991d0
                         4.520246880132533d0 1.3746682622000646d0)
                       #(1.3746682622000646d0 -6.744506851627991d0
                         4.520246880132533d0 -3.5989282336955215d0)
                       #(0.7337498336479062d0 -7.933713514338415d0
                         4.091749506878816d0 0.7337498336479062d0)
                       #(-0.7337498336479062d0 -4.091749506878816d0
                         7.933713514338415d0 -0.7337498336479062d0)
                       #(-1.3746682622000646d0 -4.520246880132533d0
                         6.744506851627991d0 3.5989282336955215d0)
                       #(3.5989282336955215d0 -4.520246880132533d0
                         6.744506851627991d0 -1.3746682622000646d0)
                       #(2.9115941025954895d0 -5.207581011232565d0
                         6.057172720527959d0 2.9115941025954895d0)
                       #(-2.9115941025954895d0 -2.9115941025954895d0
                         5.207581011232565d0 -6.057172720527959d0)
                       #(-3.5989282336955215d0 1.3746682622000646d0
                         4.520246880132533d0 -6.744506851627991d0)
                       #(1.3746682622000646d0 -3.5989282336955215d0
                         4.520246880132533d0 -6.744506851627991d0)
                       #(0.7337498336479062d0 0.7337498336479062d0
                         4.091749506878816d0 -7.933713514338415d0)
                       #(-0.7337498336479062d0 -0.7337498336479062d0
                         7.933713514338415d0 -4.091749506878816d0)
                       #(-1.3746682622000646d0 3.5989282336955215d0
                         6.744506851627991d0 -4.520246880132533d0)
                       #(3.5989282336955215d0 -1.3746682622000646d0
                         6.744506851627991d0 -4.520246880132533d0)
                       #(2.9115941025954895d0 2.9115941025954895d0
                         6.057172720527959d0 -5.207581011232565d0)
                       #(-6.057172720527959d0 5.207581011232565d0
                         -2.9115941025954895d0 2.9115941025954895d0)
                       #(-6.744506851627991d0 4.520246880132533d0
                         -3.5989282336955215d0 1.3746682622000646d0)
                       #(-6.744506851627991d0 4.520246880132533d0
                         1.3746682622000646d0 -3.5989282336955215d0)
                       #(-7.933713514338415d0 4.091749506878816d0
                         0.7337498336479062d0 0.7337498336479062d0)
                       #(-4.091749506878816d0 7.933713514338415d0
                         -0.7337498336479062d0 0.7337498336479062d0)
                       #(-4.520246880132533d0 6.744506851627991d0
                         -1.3746682622000646d0 3.5989282336955215d0)
                       #(-4.520246880132533d0 6.744506851627991d0
                         3.5989282336955215d0 -1.3746682622000646d0)
                       #(-5.207581011232565d0 6.057172720527959d0
                         2.9115941025954895d0 2.9115941025954895d0)
                       #(-2.9115941025954895d0 5.207581011232565d0
                         -6.057172720527959d0 2.9115941025954895d0)
                       #(-3.5989282336955215d0 4.520246880132533d0
                         -6.744506851627991d0 1.3746682622000646d0)
                       #(1.3746682622000646d0 4.520246880132533d0
                         -6.744506851627991d0 3.5989282336955215d0)
                       #(0.7337498336479062d0 4.091749506878816d0
                         -7.933713514338415d0 0.7337498336479062d0)
                       #(-0.7337498336479062d0 7.933713514338415d0
                         -4.091749506878816d0 0.7337498336479062d0)
                       #(-1.3746682622000646d0 6.744506851627991d0
                         -4.520246880132533d0 3.5989282336955215d0)
                       #(3.5989282336955215d0 6.744506851627991d0
                         -4.520246880132533d0 1.3746682622000646d0)
                       #(2.9115941025954895d0 6.057172720527959d0
                         -5.207581011232565d0 2.9115941025954895d0)
                       #(-2.9115941025954895d0 5.207581011232565d0
                         -2.9115941025954895d0 6.057172720527959d0)
                       #(-3.5989282336955215d0 4.520246880132533d0
                         1.3746682622000646d0 -6.744506851627991d0)
                       #(1.3746682622000646d0 4.520246880132533d0
                         -3.5989282336955215d0 6.744506851627991d0)
                       #(0.7337498336479062d0 4.091749506878816d0
                         0.7337498336479062d0 -7.933713514338415d0)
                       #(-0.7337498336479062d0 7.933713514338415d0
                         -0.7337498336479062d0 4.091749506878816d0)
                       #(-1.3746682622000646d0 6.744506851627991d0
                         3.5989282336955215d0 -4.520246880132533d0)
                       #(3.5989282336955215d0 6.744506851627991d0
                         -1.3746682622000646d0 4.520246880132533d0)
                       #(2.9115941025954895d0 6.057172720527959d0
                         2.9115941025954895d0 -5.207581011232565d0)
                       #(5.207581011232565d0 -6.057172720527959d0
                         -2.9115941025954895d0 2.9115941025954895d0)
                       #(4.520246880132533d0 -6.744506851627991d0
                         -3.5989282336955215d0 1.3746682622000646d0)
                       #(4.520246880132533d0 -6.744506851627991d0
                         1.3746682622000646d0 -3.5989282336955215d0)
                       #(4.091749506878816d0 -7.933713514338415d0
                         0.7337498336479062d0 0.7337498336479062d0)
                       #(7.933713514338415d0 -4.091749506878816d0
                         -0.7337498336479062d0 0.7337498336479062d0)
                       #(6.744506851627991d0 -4.520246880132533d0
                         -1.3746682622000646d0 3.5989282336955215d0)
                       #(6.744506851627991d0 -4.520246880132533d0
                         3.5989282336955215d0 -1.3746682622000646d0)
                       #(6.057172720527959d0 -5.207581011232565d0
                         2.9115941025954895d0 2.9115941025954895d0)
                       #(5.207581011232565d0 -2.9115941025954895d0
                         -6.057172720527959d0 2.9115941025954895d0)
                       #(4.520246880132533d0 -3.5989282336955215d0
                         -6.744506851627991d0 1.3746682622000646d0)
                       #(4.520246880132533d0 1.3746682622000646d0
                         -6.744506851627991d0 3.5989282336955215d0)
                       #(4.091749506878816d0 0.7337498336479062d0
                         -7.933713514338415d0 0.7337498336479062d0)
                       #(7.933713514338415d0 -0.7337498336479062d0
                         -4.091749506878816d0 0.7337498336479062d0)
                       #(6.744506851627991d0 -1.3746682622000646d0
                         -4.520246880132533d0 3.5989282336955215d0)
                       #(6.744506851627991d0 3.5989282336955215d0
                         -4.520246880132533d0 1.3746682622000646d0)
                       #(6.057172720527959d0 2.9115941025954895d0
                         -5.207581011232565d0 2.9115941025954895d0)
                       #(5.207581011232565d0 -2.9115941025954895d0
                         -2.9115941025954895d0 6.057172720527959d0)
                       #(4.520246880132533d0 -3.5989282336955215d0
                         1.3746682622000646d0 -6.744506851627991d0)
                       #(4.520246880132533d0 1.3746682622000646d0
                         -3.5989282336955215d0 6.744506851627991d0)
                       #(4.091749506878816d0 0.7337498336479062d0
                         0.7337498336479062d0 -7.933713514338415d0)
                       #(7.933713514338415d0 -0.7337498336479062d0
                         -0.7337498336479062d0 4.091749506878816d0)
                       #(6.744506851627991d0 -1.3746682622000646d0
                         3.5989282336955215d0 -4.520246880132533d0)
                       #(6.744506851627991d0 3.5989282336955215d0
                         -1.3746682622000646d0 4.520246880132533d0)
                       #(6.057172720527959d0 2.9115941025954895d0
                         2.9115941025954895d0 -5.207581011232565d0)
                       #(0.3039291324859653d0 0.3039291324859653d0
                         0.3039291324859653d0 8.971392480472286d0)
                       #(-0.40263101211647173d0 -0.40263101211647173d0
                         4.570965483779114d0 7.716544101711582d0)
                       #(-0.40263101211647173d0 4.570965483779114d0
                         -0.40263101211647173d0 7.716544101711582d0)
                       #(-1.0899651432165038d0 3.8836313526790818d0
                         3.8836313526790818d0 7.02920997061155d0)
                       #(4.570965483779114d0 -0.40263101211647173d0
                         -0.40263101211647173d0 7.716544101711582d0)
                       #(3.8836313526790818d0 -1.0899651432165038d0
                         3.8836313526790818d0 7.02920997061155d0)
                       #(3.8836313526790818d0 3.8836313526790818d0
                         -1.0899651432165038d0 7.02920997061155d0)
                       #(3.4121433062976583d0 3.4121433062976583d0
                         3.4121433062976583d0 6.770142979528568d0)
                       #(0.3039291324859653d0 0.3039291324859653d0
                         8.971392480472286d0 0.3039291324859653d0)
                       #(-0.40263101211647173d0 0.40263101211647173d0
                         7.716544101711582d0 4.570965483779114d0)
                       #(-0.40263101211647173d0 4.570965483779114d0
                         7.716544101711582d0 -0.40263101211647173d0)
                       #(-1.0899651432165038d0 3.8836313526790818d0
                         7.02920997061155d0 3.8836313526790818d0)
                       #(4.570965483779114d0 -0.40263101211647173d0
                         7.716544101711582d0 -0.40263101211647173d0)
                       #(3.8836313526790818d0 -1.0899651432165038d0
                         7.02920997061155d0 3.8836313526790818d0)
                       #(3.8836313526790818d0 3.8836313526790818d0
                         7.02920997061155d0 -1.0899651432165038d0)
                       #(3.4121433062976583d0 3.4121433062976583d0
                         6.770142979528568d0 3.4121433062976583d0)
                       #(0.3039291324859653d0 8.971392480472286d0
                         0.3039291324859653d0 0.3039291324859653d0)
                       #(-0.40263101211647173d0 7.716544101711582d0
                         -0.40263101211647173d0 4.570965483779114d0)
                       #(-0.40263101211647173d0 7.716544101711582d0
                         4.570965483779114d0 -0.40263101211647173d0)
                       #(-1.0899651432165038d0 7.02920997061155d0
                         3.8836313526790818d0 3.8836313526790818d0)
                       #(4.570965483779114d0 7.716544101711582d0
                         -0.40263101211647173d0 0.40263101211647173d0)
                       #(3.8836313526790818d0 7.02920997061155d0
                         -1.0899651432165038d0 3.8836313526790818d0)
                       #(3.8836313526790818d0 7.02920997061155d0
                         3.8836313526790818d0 -1.0899651432165038d0)
                       #(3.4121433062976583d0 6.770142979528568d0
                         3.4121433062976583d0 3.4121433062976583d0)
                       #(8.971392480472286d0 0.3039291324859653d0
                         0.3039291324859653d0 0.3039291324859653d0)
                       #(7.716544101711582d0 -0.40263101211647173d0
                         -0.40263101211647173d0 4.570965483779114d0)
                       #(7.716544101711582d0 -0.40263101211647173d0
                         4.570965483779114d0 -0.40263101211647173d0)
                       #(7.02920997061155d0 -1.0899651432165038d0
                         3.8836313526790818d0 3.8836313526790818d0)
                       #(7.716544101711582d0 4.570965483779114d0
                         -0.40263101211647173d0 0.40263101211647173d0)
                       #(7.02920997061155d0 3.8836313526790818d0
                         -1.0899651432165038d0 3.8836313526790818d0)
                       #(7.02920997061155d0 3.8836313526790818d0
                         3.8836313526790818d0 -1.0899651432165038d0)
                       #(6.770142979528568d0 3.4121433062976583d0
                         3.4121433062976583d0 3.4121433062976583d0)))
          (table (u:make-f64-array 8192)))
      (dotimes (i 2048)
        (setf (aref table (* i 4)) (aref (aref gradients (mod i 160)) 0)
              (aref table (+ (* i 4) 1)) (aref (aref gradients (mod i 160)) 1)
              (aref table (+ (* i 4) 2)) (aref (aref gradients (mod i 160)) 2)
              (aref table (+ (* i 4) 3)) (aref (aref gradients (mod i 160)) 3)))
      table)
  :test #'equalp)

(defstruct (gen:open-simplex2s-4d
            (:include int:sampler)
            (:conc-name "")
            (:predicate nil)
            (:copier nil))
  (gradients (u:make-f64-array 8192) :type (u:f64a 8192))
  (table (u:make-b16-array 2048) :type (u:b16a 2048))
  (orientation :standard :type (member :standard :xy/zw :xz/yw :xyz/w)))

(u:fn-> permute (rng:generator) (values (u:f64a 8192) (u:b16a 2048)))
(defun permute (rng)
  (declare (optimize speed))
  (let ((source (u:make-b16-array 2048))
        (table (u:make-b16-array 2048))
        (gradients (u:make-f64-array 8192)))
    (dotimes (i 2048)
      (setf (aref source i) i))
    (loop :for i :from 2047 :downto 0
          :for r = (mod (+ (rng:int rng 0 #.(1- (expt 2 32)) nil) 31) (1+ i))
          :for x = (aref source r)
          :for pgi = (* i 4)
          :for gi = (* x 4)
          :do (setf (aref table i) x
                    (aref gradients pgi) (aref +gradients+ gi)
                    (aref gradients (+ pgi 1)) (aref +gradients+ (+ gi 1))
                    (aref gradients (+ pgi 2)) (aref +gradients+ (+ gi 2))
                    (aref gradients (+ pgi 3)) (aref +gradients+ (+ gi 3))
                    (aref source r) (aref source i)))
    (values gradients table)))

(declaim (inline orient))
(defun orient (sampler x y z w)
  (ecase (orientation sampler)
    (:standard
     (let ((s (* (+ x y z w) 0.309016994374947d0)))
       (values (+ x s) (+ y s) (+ z s) (+ w s))))
    (:xy/zw
     (let ((s2 (+ (* (+ x y) -0.28522513987434876941d0)
                  (* (+ z w) 0.83897065470611435718d0)))
           (t2 (+ (* (+ z w) 0.21939749883706435719d0)
                  (* (+ x y) -0.48214856493302476942d0))))
       (values (+ x s2) (+ y s2) (+ z t2) (+ w t2))))
    (:xz/yw
     (let ((s2 (+ (* (+ x z) -0.28522513987434876941d0)
                  (* (+ y w) 0.83897065470611435718d0)))
           (t2 (+ (* (+ y w) 0.21939749883706435719d0)
                  (* (+ x z) -0.48214856493302476942d0))))
       (values (+ x s2) (+ y t2) (+ z s2) (+ w t2))))
    (:xyz/w
     (let* ((xyz (+ x y z))
            (ww (* w 1.118033988749894d0))
            (s2 (+ (* xyz -0.16666666666666666d0) ww)))
       (values (+ x s2) (+ y s2) (+ z s2) (+ (* xyz -0.5d0) ww))))))

(defun gen:open-simplex2s-4d (&key seed (orientation :standard))
  "Construct a sampler that, when sampled, outputs 4-dimensional OpenSimplex2S noise values ranging
from -1.0 to 1.0.

`seed`: A string used to seed the random number generator for this sampler, or NIL. If a seed is not
supplied, one will be generated automatically which will negatively affect the reproducibility of
the noise (optional, default: NIL).

`orientation`: One of `:standard`, `:xy/zw`, `:xz/yw`, or `:xyz/w`, denoting the orientation of the
lattice. `:xy/zw` is recommended for 3D terrain where X/Y or Z/W are horizontal. `:xz/yw` is
recommended for 3D terrain where X/Z or Y/W are horizontal. `:xyz/w` is recommended for time-varied
animations of 3D objects, where W is time (optional, default: `:standard`)."
  (unless (member orientation '(:standard :xy/zw :xz/yw :xyz/w))
    (error 'int:invalid-open-simplex2-orientation
           :sampler-type 'open-simplex2s-4d
           :orientation orientation
           :valid-orientations '(:standard :xy/zw :xz/yw :xyz/w)))
  (u:mvlet* ((rng (int::make-rng seed))
             (gradients table (permute rng)))
    (make-open-simplex2s-4d :rng rng
                            :gradients gradients
                            :table table
                            :orientation orientation)))

(defmethod int:sample ((sampler gen:open-simplex2s-4d) x &optional (y 0d0) (z 0d0) (w 0d0))
  (declare (optimize speed)
           (int::f50 x y z w))
  (u:mvlet* ((gradients (gradients sampler))
             (table (table sampler))
             (value 0d0)
             (xs ys zs ws (orient sampler x y z w))
             (xsb xsi (floor xs))
             (ysb ysi (floor ys))
             (zsb zsi (floor zs))
             (wsb wsi (floor ws))
             (ssi (* (+ xsi ysi zsi wsi) -0.138196601125011d0))
             (xi (+ xsi ssi))
             (yi (+ ysi ssi))
             (zi (+ zsi ssi))
             (wi (+ wsi ssi))
             (index (logior (logand (floor (* xs 4)) 3)
                            (ash (logand (floor (* ys 4)) 3) 2)
                            (ash (logand (floor (* zs 4)) 3) 4)
                            (ash (logand (floor (* ws 4)) 3) 6))))
    (declare (u:f64 value))
    (let ((lattice-points (aref +lookup+ index)))
      (declare (simple-vector lattice-points))
      (dotimes (i (length lattice-points) (float value 1f0))
        (let* ((c (aref lattice-points i))
               (dx (+ xi (dx c)))
               (dy (+ yi (dy c)))
               (dz (+ zi (dz c)))
               (dw (+ wi (dw c)))
               ;; NOTE: This 0.77 constant is different from the reference implementation's 0.8
               ;; because that results in the output domain being very out of range. 0.77 gives a
               ;; range very close to [-1, 1].
               (attn (- 0.77 (* dx dx) (* dy dy) (* dz dz) (* dw dw))))
          (when (plusp attn)
            (setf attn (* attn attn))
            (let* ((pxm (aref table (logand (+ xsb (xsv c)) 2047)))
                   (pym (aref table (logxor pxm (logand (+ ysb (ysv c)) 2047))))
                   (pzm (aref table (logxor pym (logand (+ zsb (zsv c)) 2047))))
                   (pwm (aref table (logxor pzm (logand (+ wsb (wsv c)) 2047))))
                   (grad-index (* pwm 4))
                   (grad-x (* (aref gradients grad-index) dx))
                   (grad-y (* (aref gradients (+ grad-index 1)) dy))
                   (grad-z (* (aref gradients (+ grad-index 2)) dz))
                   (grad-w (* (aref gradients (+ grad-index 2)) dw)))
              (incf value (* attn attn (+ grad-x grad-y grad-z grad-w))))))))))
